name: Auto I18n Migration

on:
  workflow_dispatch:
    inputs:
      i18n_plus_repo:
        description: 'Repo of i18n-plus tools (format: owner/repo)'
        required: true
        default: 'dangehub/obsidian-plugins-i18n-plus'
      target_main_file:
        description: 'Path to main.ts'
        required: true
        default: 'src/main.ts'

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Checkout i18n-plus Tools
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.i18n_plus_repo }}
          path: _i18n_tools

      - name: Copy Adapter
        run: |
          # Detect source folder
          SRC_DIR=$(dirname ${{ inputs.target_main_file }})
          mkdir -p $SRC_DIR/lang
          
          # Copy generic adapter from i18n-plus tools
          if [ -f "_i18n_tools/templates/adapter.ts" ]; then
            cp _i18n_tools/templates/adapter.ts $SRC_DIR/lang/i18n.ts
            echo "âœ… Adapter successfully copied."
          else
            echo "âŒ Error: _i18n_tools/templates/adapter.ts not found."
            exit 1
          fi

      - name: Install jscodeshift
        run: npm install -g jscodeshift typescript

      - name: Inject Initialization Code
        run: |
          jscodeshift -t _i18n_tools/scripts/inject-i18n.cjs ${{ inputs.target_main_file }} --parser=ts --run-in-band

      - name: Replace Strings (Codemod)
        run: |
          SRC_DIR=$(dirname ${{ inputs.target_main_file }})
          echo "Running codemod on $SRC_DIR with extensions ts,tsx..."
          I18N_GENERATE_LOG=true jscodeshift -t _i18n_tools/scripts/i18n-codemod.cjs $SRC_DIR \
            --parser=ts \
            --extensions=ts,tsx \
            --run-in-band 2>&1 | tee codemod_output.log

      - name: Generate Migration Report
        run: |
          cat codemod_output.log | node _i18n_tools/scripts/generate-report.cjs --locale zh-CN --output MIGRATION_REPORT.md
          echo "## ğŸ“Š è¿ç§»æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          cat MIGRATION_REPORT.md >> $GITHUB_STEP_SUMMARY

      - name: Extract Keys
        run: |
          SRC_DIR=$(dirname ${{ inputs.target_main_file }})
          node _i18n_tools/scripts/extract-keys.cjs $SRC_DIR

      - name: Format Code
        run: |
          # Try to run prettier if it exists in the project
          if npx --no-install prettier --version >/dev/null 2>&1; then
             npx prettier --write "${{ inputs.target_main_file }}"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'refactor: Auto-migrate to i18n-plus'
          body: |
            This PR was automatically generated by i18n-plus migration workflow.
            
            ## å˜æ›´å†…å®¹
            - æ³¨å…¥ i18n é€‚é…å™¨ (`lang/i18n.ts`)
            - åˆå§‹åŒ– `main.ts` ä¸­çš„ i18n
            - è‡ªåŠ¨æ›¿æ¢å­—ç¬¦ä¸²ä¸º `t()` è°ƒç”¨
            - ç”Ÿæˆé»˜è®¤ `en.ts` è¯­è¨€æ–‡ä»¶
            
            ## âš ï¸ è¿ç§»æŠ¥å‘Š
            è¯·æŸ¥çœ‹ä»“åº“ä¸­çš„ `MIGRATION_REPORT.md` äº†è§£é£é™©é¡¹è¯¦æƒ…ã€‚
            
            **äººå·¥å¤æ ¸é¡¹**:
            - ğŸ”´ é«˜é£é™©é¡¹ (DOM æ··åˆæ¨¡å¼)
            - âš ï¸ ä¸­é£é™©é¡¹ (å­—ç¬¦ä¸²æ‹¼æ¥)
          branch: refactor/i18n-plus-migration
